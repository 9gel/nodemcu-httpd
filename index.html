<!DOCTYPE html>
<html>
  <head>
    <title>DSL lights</title>
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" sizes="82x99" href="http://www.dimsumlabs.com/wp-content/uploads/2014/08/logo_dsl_text_82x99.png">
  </head>
  <body style="margin: 0px; padding: 0px;">
     <canvas id="colorspace">
     </canvas>
  </body>
  <script type="text/javascript">
  (function (){
    var canvas = document.getElementById('colorspace');
    var ctx = canvas.getContext('2d');

    function drawCanvas() {
      var colours = ctx.createLinearGradient(0, 0, window.innerWidth, 0);
      for(var i=0; i <= 360; i+=10) {
        colours.addColorStop(i/360, 'hsl(' + i + ', 100%, 50%)');
      }

      ctx.fillStyle = colours;
      ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

      var luminance = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
      luminance.addColorStop(0, '#ffffff');
      luminance.addColorStop(0.05, '#ffffff');
      luminance.addColorStop(0.5, 'rgba(0,0,0,0)');
      luminance.addColorStop(0.95,  '#000000');
      luminance.addColorStop(1,  '#000000');

      ctx.fillStyle = luminance;
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    }

    var canSend = true;
    var pending = false;
    var rr=127, gg=127, bb=127;
    function sendColour() {
      function colourCorrect(v) {
        v = Math.max(0, Math.min(255, v));
        return Math.round(1023-(v*v)/64);
      }

      var params = [
        'r=' + colourCorrect(rr),
        'g=' + colourCorrect(gg),
        'b=' + colourCorrect(bb)
      ].join('&');
      canSend = pending = false;
      var req = new XMLHttpRequest();
      req.open("POST", '/rgb.lua?' + params, true);
      req.send();
      req.onreadystatechange = function() {
        if (req.readyState == 4) {
          setTimeout(function() { if (pending) sendColour(); else canSend = true; }, 100);
        }
      }
    }

    function setColour(r, g, b) {
      if (r == rr && g == gg && b == bb) {
        return;
      }
      if (r < 0 && g < 0 && b < 0) {
        return;
      }
      if (r > 255 && g > 255 && b > 255) {
        return;
      }
      rr = r;
      gg = g;
      bb = b;
      pending = true;
      if (canSend) {
        sendColour();
      }
    }

    function handleEvent(clientX, clientY) {
      var data = ctx.getImageData(clientX, clientY, 1, 1).data;
      setColour(data[0], data[1], data[2]);
    }
    canvas.addEventListener("touchmove", function(event){
      handleEvent(event.touches[0].clientX, event.touches[0].clientY);
    }, false);

    canvas.addEventListener('mousewheel', function(event) {
      var delta = Math.min(1, Math.max(-1, event.wheelDelta || -event.detail));
      setColour(rr + delta, gg + delta, bb + delta);
      event.preventDefault();
      return false;
    }, false);

    var mouseDown = false;
    canvas.addEventListener('mousedown', function(event) {
      if (event.button == 0) {
        handleEvent(event.clientX, event.clientY);
        mouseDown = true;
      }
    }, false);
    document.addEventListener('mouseup', function(event) {
      if (event.button == 0) {
        mouseDown = false;
      }
    }, false);
    canvas.addEventListener('mousemove', function(event) {
      if (mouseDown) {
        handleEvent(event.clientX, event.clientY);
      }
    }, false);

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        drawCanvas();
    }
    window.addEventListener('resize', resizeCanvas, false);

    resizeCanvas();
    drawCanvas();

    document.ontouchmove = function(e) {e.preventDefault()};
  })();
  </script>
</html>
